# Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ: Backend Ğ´Ğ»Ñ precious.you

**Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹:** https://github.com/SNNikitin/precious.you-backend

## 1. ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

**ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:** precious.you  
**Ğ¡Ğ»Ğ¾Ğ³Ğ°Ğ½:** â€œyes, you areâ€  
**Ğ”Ğ¾Ğ¼ĞµĞ½:** precious.you

### 1.1 ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

ĞœĞ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿ÑƒÑˆ-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ñ Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¼Ğ¸, Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‰Ğ¸Ğ¼Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼Ğ¸. Ğ¦ĞµĞ»ÑŒ â€” Ğ´Ğ°Ñ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼ Ğ±ĞµĞ·ÑƒÑĞ»Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¸Ğµ Ğ¸ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ.

### 1.2 Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ

- **MVP:** Ğ¶ĞµĞ½ÑĞºĞ°Ñ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ 18-35 Ğ»ĞµÑ‚
- **Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ:** Ğ´ĞµÑ‚Ğ¸, Ğ¿Ğ¸Ñ‚Ğ¾Ğ¼Ñ†Ñ‹ (Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†ĞµĞ²), Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ´ĞµĞ¼Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ğ¸

-----

## 2. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### 2.1 Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸

```
POST   /api/v1/auth/apple        # Ğ’Ñ…Ğ¾Ğ´ Ñ‡ĞµÑ€ĞµĞ· Apple
POST   /api/v1/auth/google       # Ğ’Ñ…Ğ¾Ğ´ Ñ‡ĞµÑ€ĞµĞ· Google
POST   /api/v1/auth/logout       # Ğ’Ñ‹Ñ…Ğ¾Ğ´
POST   /api/v1/auth/refresh      # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ°
DELETE /api/v1/auth/account      # Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
GET    /api/v1/auth/me           # Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
```

**OAuth Flow:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚â”€â”€â”€â”€â–¶â”‚  Apple/  â”‚â”€â”€â”€â”€â–¶â”‚  Backend â”‚
â”‚   App    â”‚     â”‚  Google  â”‚     â”‚   API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                  â”‚
     â”‚  1. ĞĞ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ "Sign in with..."    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                  â”‚
     â”‚  2. OAuth redirect               â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚                                  â”‚
     â”‚  3. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞµÑ‚ÑÑ    â”‚
     â”‚         Ğ² Apple/Google           â”‚
     â”‚                                  â”‚
     â”‚  4. identity_token + user_info   â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                                  â”‚
     â”‚  5. Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°           â”‚
     â”‚     Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ user     â”‚
     â”‚     Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ JWT                â”‚
     â”‚                                  â”‚
     â”‚  6. { access_token, refresh_token, user }
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**Request: Sign in with Apple**

```typescript
// POST /api/v1/auth/apple
interface AppleAuthRequest {
  identity_token: string;      // JWT Ğ¾Ñ‚ Apple
  authorization_code: string;  // Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ refresh_token
  user?: {                     // Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ñ…Ğ¾Ğ´Ğµ
    email: string;
    name?: {
      firstName: string;
      lastName: string;
    };
  };
}
```

**Request: Sign in with Google**

```typescript
// POST /api/v1/auth/google
interface GoogleAuthRequest {
  id_token: string;            // JWT Ğ¾Ñ‚ Google
  access_token?: string;       // Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾
}
```

**Response: ÑƒÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**

```typescript
interface AuthResponse {
  access_token: string;        // JWT, 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  refresh_token: string;       // JWT, 30 Ğ´Ğ½ĞµĞ¹
  user: {
    id: string;
    email: string;
    display_name: string;
    is_new_user: boolean;      // true ĞµÑĞ»Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»ÑÑ
  };
}
```

**ĞœĞ¾Ğ´ĞµĞ»ÑŒ User:**

```typescript
interface User {
  id: string;                    // UUID
  email: string;                 // Ğ¸Ğ· Apple/Google, ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹
  display_name: string;          // ĞºĞ°Ğº Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°Ñ‚ÑŒÑÑ Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑÑ…
  gender: 'female' | 'male' | 'neutral' | null;
  language: string;              // ru, en, etc.
  timezone: string;              // Ğ´Ğ»Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
  
  // OAuth Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹
  apple_id: string | null;       // Apple user ID (sub)
  google_id: string | null;      // Google user ID (sub)
  
  avatar_url: string | null;     // Ğ¸Ğ· Google (Apple Ğ½Ğµ Ğ´Ğ°Ñ‘Ñ‚)
  created_at: timestamp;
  updated_at: timestamp;
}
```

**ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Apple Sign In:**

- Apple Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ñ‚ email Ğ¸ Ğ¸Ğ¼Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ ĞŸĞ•Ğ Ğ’ĞĞœ Ğ²Ñ…Ğ¾Ğ´Ğµ â€” Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ ÑÑ€Ğ°Ğ·Ñƒ
- Apple Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞºÑ€Ñ‹Ñ‚ÑŒ email (Private Email Relay) â€” Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ ÑÑ‚Ğ¸Ğ¼
- Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ identity_token Ñ‡ĞµÑ€ĞµĞ· Apple Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸
- Ğ”Ğ»Ñ App Store Review: Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ° ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ OAuth

**ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Google Sign In:**

- Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ñ‚ email Ğ¸ Ğ¸Ğ¼Ñ
- Ğ”Ğ°Ñ‘Ñ‚ avatar_url
- Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ id_token Ñ‡ĞµÑ€ĞµĞ· Google Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸

### 2.2 ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹

```
GET    /api/v1/settings              # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
PUT    /api/v1/settings              # ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
POST   /api/v1/settings/test-push    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
```

**ĞœĞ¾Ğ´ĞµĞ»ÑŒ NotificationSettings:**

```typescript
interface NotificationSettings {
  user_id: string;
  enabled: boolean;                    // Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ
  frequency: 'rare' | 'normal' | 'often';  // 1-2, 3-5, 6-10 Ğ² Ğ´ĞµĞ½ÑŒ
  quiet_hours_start: string;           // "23:00"
  quiet_hours_end: string;             // "08:00"
  categories: string[];                // Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
  push_token: string;                  // FCM/APNs Ñ‚Ğ¾ĞºĞµĞ½
  device_type: 'ios' | 'android';
}
```

### 2.3 Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹

```
GET    /api/v1/messages              # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸)
GET    /api/v1/messages/:id          # ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
GET    /api/v1/messages/categories   # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹
POST   /api/v1/messages/favorite     # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ
DELETE /api/v1/messages/favorite/:id # Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ· Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾
GET    /api/v1/messages/favorites    # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾
```

**ĞœĞ¾Ğ´ĞµĞ»ÑŒ Message:**

```typescript
interface Message {
  id: string;
  text_template: string;           // "{{name}}, Ñ‚Ñ‹ ÑƒĞ¼Ğ½Ğ¸Ñ‡ĞºĞ°!"
  category: string;                // "affirmation", "motivation", "comfort"
  gender_variant: 'female' | 'male' | 'neutral';
  language: string;
  is_active: boolean;
  created_at: timestamp;
}
```

**ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (MVP):**

- `affirmation` â€” â€œÑ‚Ñ‹ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ°Ñâ€, â€œÑ‚Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾â€
- `motivation` â€” â€œÑ‚Ñ‹ ÑĞ¿Ñ€Ğ°Ğ²Ğ¸ÑˆÑŒÑÑâ€, â€œÑƒ Ñ‚ĞµĞ±Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑÑâ€
- `comfort` â€” â€œĞ²ÑÑ‘ Ğ±ÑƒĞ´ĞµÑ‚ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾â€, â€œÑ‚Ñ‹ Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸â€
- `appreciation` â€” â€œÑ‚Ñ‹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´ĞµÑ†â€, â€œÑ‚Ñ‹ ÑƒĞ¼Ğ½Ğ¸Ñ‡ĞºĞ°â€
- `self_worth` â€” â€œÑ‚Ñ‹ Ñ†ĞµĞ½Ğ½Ğ°Ñâ€, â€œÑ‚Ñ‹ Ğ²Ğ°Ğ¶Ğ½Ğ°Ñâ€

### 2.4 Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°

```
GET    /api/v1/history               # Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
GET    /api/v1/stats                 # Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
```

**ĞœĞ¾Ğ´ĞµĞ»ÑŒ NotificationHistory:**

```typescript
interface NotificationHistory {
  id: string;
  user_id: string;
  message_id: string;
  sent_at: timestamp;
  opened: boolean;
  opened_at: timestamp | null;
}
```

### 2.5 ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ (Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ¼Ğ¾Ğ½ĞµÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)

```
GET    /api/v1/subscription          # Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°
POST   /api/v1/subscription/verify   # Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ (App Store/Google Play)
```

**ĞœĞ¾Ğ´ĞµĞ»ÑŒ Subscription:**

```typescript
interface Subscription {
  user_id: string;
  plan: 'free' | 'premium';
  platform: 'ios' | 'android' | 'web';
  store_transaction_id: string | null;
  expires_at: timestamp | null;
}
```

-----

## 3. Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### 3.1 Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚ĞµĞº

|ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚|Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ              |ĞĞ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ               |
|---------|------------------------|--------------------------|
|Runtime  |Node.js 20+ / Bun       |ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ, ÑĞºĞ¾ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° |
|Framework|Hono / Fastify          |Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹, Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹           |
|Database |PostgreSQL 16           |ĞĞ°Ğ´Ñ‘Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ, JSON Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°|
|ORM      |Drizzle ORM             |Type-safe, Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹         |
|Cache    |Redis                   |Ğ¡ĞµÑÑĞ¸Ğ¸, rate limiting     |
|Queue    |BullMQ                  |ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹       |
|Push     |Firebase Cloud Messaging|ĞšÑ€Ğ¾ÑÑ-Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°           |

### 3.2 ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Load Balancer                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Server                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Auth   â”‚  â”‚ Settings â”‚  â”‚ Messages â”‚  â”‚  Stats   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL   â”‚ â”‚     Redis     â”‚ â”‚    BullMQ     â”‚
â”‚   (Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)    â”‚ â”‚ (ĞºÑÑˆ/ÑĞµÑÑĞ¸Ğ¸)  â”‚ â”‚   (Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Push Worker   â”‚
                                    â”‚  (FCM/APNs)   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ (Push Worker)

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**

1. ĞšĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ¿Ğ¾Ñ€Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
1. Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ timezone Ğ¸ quiet_hours ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
1. Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹
1. ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ (Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ğ¼Ñ, ÑĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ)
1. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· FCM
1. Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹:**

```typescript
const FREQUENCY_CONFIG = {
  rare: { min: 1, max: 2, minIntervalHours: 8 },
  normal: { min: 3, max: 5, minIntervalHours: 3 },
  often: { min: 6, max: 10, minIntervalHours: 1 }
};
```

-----

## 4. Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (PostgreSQL Schema)

```sql
-- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  display_name VARCHAR(100),
  gender VARCHAR(20) DEFAULT 'female',
  language VARCHAR(10) DEFAULT 'ru',
  timezone VARCHAR(50) DEFAULT 'Europe/Moscow',
  
  -- OAuth Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹
  apple_id VARCHAR(255) UNIQUE,
  google_id VARCHAR(255) UNIQUE,
  avatar_url TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¿Ğ¾ OAuth ID
CREATE INDEX idx_users_apple_id ON users(apple_id) WHERE apple_id IS NOT NULL;
CREATE INDEX idx_users_google_id ON users(google_id) WHERE google_id IS NOT NULL;

-- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
CREATE TABLE notification_settings (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  enabled BOOLEAN DEFAULT true,
  frequency VARCHAR(20) DEFAULT 'normal',
  quiet_hours_start TIME DEFAULT '23:00',
  quiet_hours_end TIME DEFAULT '08:00',
  categories TEXT[] DEFAULT ARRAY['affirmation', 'motivation', 'comfort', 'appreciation', 'self_worth'],
  push_token TEXT,
  device_type VARCHAR(20),
  last_notification_at TIMESTAMPTZ,
  notifications_today INT DEFAULT 0,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  text_template TEXT NOT NULL,
  category VARCHAR(50) NOT NULL,
  gender_variant VARCHAR(20) DEFAULT 'female',
  language VARCHAR(10) DEFAULT 'ru',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ğ˜Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
CREATE TABLE favorite_messages (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  message_id UUID REFERENCES messages(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, message_id)
);

-- Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
CREATE TABLE notification_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  message_id UUID REFERENCES messages(id),
  message_text TEXT NOT NULL,
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  opened BOOLEAN DEFAULT false,
  opened_at TIMESTAMPTZ
);

-- ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
CREATE TABLE subscriptions (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  plan VARCHAR(20) DEFAULT 'free',
  platform VARCHAR(20),
  store_transaction_id TEXT,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹
CREATE INDEX idx_notification_settings_enabled ON notification_settings(enabled) WHERE enabled = true;
CREATE INDEX idx_notification_history_user_sent ON notification_history(user_id, sent_at DESC);
CREATE INDEX idx_messages_category_active ON messages(category, is_active) WHERE is_active = true;
```

-----

## 5. Seed Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ)

```typescript
const SEED_MESSAGES = [
  // Affirmation
  { text: "{{name}}, Ñ‚Ñ‹ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ°Ñ ğŸ’›", category: "affirmation" },
  { text: "Ğ¢Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾. ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ñ‚Ğ°ĞºĞ°Ñ, ĞºĞ°ĞºĞ°Ñ ĞµÑÑ‚ÑŒ", category: "affirmation" },
  { text: "{{name}}, Ñ‚Ñ‹ Ğ·Ğ°ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°ĞµÑˆÑŒ Ğ»ÑĞ±Ğ²Ğ¸", category: "affirmation" },
  { text: "Ğ¢Ñ‹ Ñ†ĞµĞ½Ğ½Ğ°Ñ. ĞĞµ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ğ¹ Ğ¾Ğ± ÑÑ‚Ğ¾Ğ¼", category: "affirmation" },
  
  // Motivation  
  { text: "{{name}}, Ñ‚Ñ‹ ÑĞ¿Ñ€Ğ°Ğ²Ğ¸ÑˆÑŒÑÑ! ğŸ’ª", category: "motivation" },
  { text: "Ğ£ Ñ‚ĞµĞ±Ñ Ğ²ÑÑ‘ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑÑ", category: "motivation" },
  { text: "Ğ¢Ñ‹ ÑĞ¸Ğ»ÑŒĞ½ĞµĞµ, Ñ‡ĞµĞ¼ Ğ´ÑƒĞ¼Ğ°ĞµÑˆÑŒ", category: "motivation" },
  { text: "ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ ÑˆĞ°Ğ³ â€” ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ", category: "motivation" },
  
  // Comfort
  { text: "Ğ’ÑÑ‘ Ğ±ÑƒĞ´ĞµÑ‚ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸŒ¸", category: "comfort" },
  { text: "{{name}}, Ñ‚Ñ‹ Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸", category: "comfort" },
  { text: "ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ. ĞĞµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ´Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ", category: "comfort" },
  { text: "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾Ñ‚Ğ´Ğ¾Ñ…Ğ½ÑƒÑ‚ÑŒ", category: "comfort" },
  
  // Appreciation
  { text: "{{name}}, Ñ‚Ñ‹ ÑƒĞ¼Ğ½Ğ¸Ñ‡ĞºĞ°! âœ¨", category: "appreciation" },
  { text: "Ğ¢Ñ‹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´ĞµÑ†, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ°Ñ€Ğ°ĞµÑˆÑŒÑÑ", category: "appreciation" },
  { text: "Ğ“Ğ¾Ñ€Ğ¶ÑƒÑÑŒ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹", category: "appreciation" },
  
  // Self-worth
  { text: "Ğ¢Ñ‹ Ğ²Ğ°Ğ¶Ğ½Ğ°Ñ", category: "self_worth" },
  { text: "{{name}}, Ğ¼Ğ¸Ñ€ Ğ»ÑƒÑ‡ÑˆĞµ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ² Ğ½Ñ‘Ğ¼ ĞµÑÑ‚ÑŒ", category: "self_worth" },
  { text: "Ğ¢Ñ‹ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸ Ğ½ĞµĞ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ¼Ğ°Ñ", category: "self_worth" },
];
```

-----

## 6. Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### 6.1 ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

- **OAuth 2.0:** Sign in with Apple + Sign in with Google
- JWT Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ (access 15 Ğ¼Ğ¸Ğ½, refresh 30 Ğ´Ğ½ĞµĞ¹)
- Rate limiting: 100 req/min Ğ½Ğ° IP, 1000 req/min Ğ½Ğ° user

### 6.2 Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ OAuth Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²

**Apple Identity Token:**

```typescript
// Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· JWKS
// https://appleid.apple.com/auth/keys
async function verifyAppleToken(identityToken: string): Promise<ApplePayload> {
  const APPLE_JWKS_URL = 'https://appleid.apple.com/auth/keys';
  // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸ Apple
  // 2. Ğ”ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ header Ñ‚Ğ¾ĞºĞµĞ½Ğ°, Ğ²Ğ·ÑÑ‚ÑŒ kid
  // 3. ĞĞ°Ğ¹Ñ‚Ğ¸ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ»ÑÑ‡
  // 4. Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ
  // 5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ: iss = "https://appleid.apple.com"
  // 6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ: aud = Ğ½Ğ°Ñˆ app bundle ID
  // 7. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ: exp > now
  return payload; // { sub, email, email_verified }
}
```

**Google ID Token:**

```typescript
// Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Google OAuth2 Client
// npm: google-auth-library
import { OAuth2Client } from 'google-auth-library';

const client = new OAuth2Client(GOOGLE_CLIENT_ID);

async function verifyGoogleToken(idToken: string): Promise<GooglePayload> {
  const ticket = await client.verifyIdToken({
    idToken,
    audience: GOOGLE_CLIENT_ID,
  });
  return ticket.getPayload(); // { sub, email, name, picture }
}
```

### 6.3 Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ

- Zod ÑÑ…ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- Sanitization email Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹
- ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ğ¸Ğ½Ğ° display_name: 100 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²

### 6.4 GDPR/ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ

- Endpoint Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° (+ revoke Apple/Google tokens)
- Endpoint Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ±Ğ¾Ñ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Apple Private Email Relay

-----

## 7. Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹

### 7.1 ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° OAuth Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ¾Ğ²

**Apple Sign In (Apple Developer Console):**

1. Ğ—Ğ°Ğ¹Ñ‚Ğ¸ Ğ² [developer.apple.com](https://developer.apple.com)
1. Certificates, Identifiers & Profiles â†’ Identifiers
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ App ID Ñ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½Ğ½Ñ‹Ğ¼ â€œSign in with Appleâ€
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Services ID Ğ´Ğ»Ñ web (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶ĞµĞ½ web-ĞºĞ»Ğ¸ĞµĞ½Ñ‚)
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Key Ğ´Ğ»Ñ Sign in with Apple â†’ ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ .p8 Ñ„Ğ°Ğ¹Ğ»
1. Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ: Team ID, Key ID, Bundle ID, Private Key

**Google Sign In (Google Cloud Console):**

1. Ğ—Ğ°Ğ¹Ñ‚Ğ¸ Ğ² [console.cloud.google.com](https://console.cloud.google.com)
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹
1. APIs & Services â†’ Credentials
1. Create Credentials â†’ OAuth 2.0 Client IDs
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ»Ñ iOS (Bundle ID) Ğ¸ Android (SHA-1)
1. Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ: Client ID Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹

### 7.2 ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

- `development` â€” Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°
- `staging` â€” Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- `production` â€” Ğ±Ğ¾ĞµĞ²Ğ¾Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€

### 7.3 ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

```env
# Database
DATABASE_URL=postgresql://user:pass@host:5432/precious

# Redis
REDIS_URL=redis://host:6379

# JWT
JWT_SECRET=your-secret-key
JWT_REFRESH_SECRET=your-refresh-secret

# Apple Sign In
APPLE_TEAM_ID=XXXXXXXXXX
APPLE_CLIENT_ID=you.precious.app          # Bundle ID
APPLE_KEY_ID=XXXXXXXXXX
APPLE_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----...

# Google Sign In
GOOGLE_CLIENT_ID=xxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret    # Ğ´Ğ»Ñ web, Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ mobile

# Firebase (Push Notifications)
FIREBASE_PROJECT_ID=precious-you
FIREBASE_PRIVATE_KEY=...
FIREBASE_CLIENT_EMAIL=...

# App
NODE_ENV=production
PORT=3000
API_URL=https://api.precious.you
```

### 7.4 Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ Ñ…Ğ¾ÑÑ‚Ğ¸Ğ½Ğ³

- **API:** Railway / Render / Fly.io
- **Database:** Supabase / Neon (managed PostgreSQL)
- **Redis:** Upstash (serverless Redis)

-----

## 8. MVP Scope

### Ğ¤Ğ°Ğ·Ğ° 1 (MVP)

- [x] Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ/Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- [x] Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
- [x] Push Worker Ñ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼
- [x] 20+ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ (Ğ¶ĞµĞ½ÑĞºĞ¸Ğ¹ Ñ€Ğ¾Ğ´)
- [x] Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹

### Ğ¤Ğ°Ğ·Ğ° 2

- [ ] Ğ˜Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
- [ ] ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ·Ñ‹ĞºĞ¸
- [ ] ĞœÑƒĞ¶ÑĞºĞ¾Ğ¹/Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ¾Ğ´
- [ ] Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°

### Ğ¤Ğ°Ğ·Ğ° 3

- [ ] Premium Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°
- [ ] ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
- [ ] Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚Ñ‹
- [ ] API Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ¾Ğ²

-----

## 9. Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```bash
# ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
git clone git@github.com:SNNikitin/precious.you-backend.git
cd precious.you-backend

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
bun install

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
cp .env.example .env
# Ğ¾Ñ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ .env

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ‘Ğ” (Docker)
docker-compose up -d postgres redis

# ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
bun run db:migrate
bun run db:seed

# Ğ—Ğ°Ğ¿ÑƒÑĞº
bun run dev        # development
bun run start      # production
bun run worker     # push worker Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾
```

-----

## 10. ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸ Ñ€ĞµÑÑƒÑ€ÑÑ‹

**ĞŸÑ€Ğ¾ĞµĞºÑ‚:** precious.you  
**Ğ”Ğ¾Ğ¼ĞµĞ½:** precious.you  
**Ğ‘Ñ€ĞµĞ½Ğ´Ğ±ÑƒĞº:** precious-brand-guidelines.html  
**Ğ¦Ğ²ĞµÑ‚Ğ°:** Primary #5D4E4E, Accent #FFE5A0

-----

*Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Claude Code*  
*Ğ’ĞµÑ€ÑĞ¸Ñ: 1.0*  
*Ğ”Ğ°Ñ‚Ğ°: Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ 2025*
